<div class="min-h-screen bg-gray-50">
  <!-- Header Bar -->
  <div
    *ngIf="isTestStarted && !isTestCompleted"
    class="bg-blue-800 text-white px-6 py-4 flex items-center justify-between shadow-lg"
  >
    <div class="flex items-center gap-6">
      <h1 class="text-lg font-bold">HỆ THỐNG THI TRỰC TUYẾN</h1>
    </div>
    <div class="flex items-center gap-6">
      <button
        (click)="submitTest()"
        class="bg-orange-500 hover:bg-orange-600 px-6 py-2 rounded-lg font-semibold transition-colors"
      >
        NỘP BÀI
      </button>
      <div class="bg-blue-700 px-4 py-2 rounded-lg font-mono text-lg">
        <fa-icon [icon]="faClock" class="mr-2"></fa-icon>
        {{ getFormattedTime() }}
      </div>
      <div class="text-sm" (click)="toggleQuestionGrid()">
        <fa-icon [icon]="faQuestion" class="mr-2"></fa-icon>
      </div>
    </div>
  </div>

  <!-- Loading State -->
  <div *ngIf="isLoading" class="flex justify-center items-center min-h-screen">
    <div class="text-center">
      <div
        class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mb-4"
      ></div>
      <p class="text-gray-600">Đang tải bài test...</p>
    </div>
  </div>

  <!-- Error State -->
  <div
    *ngIf="error && !isLoading"
    class="bg-red-50 border border-red-200 rounded-lg p-4 m-6"
  >
    <p class="text-red-800">{{ error }}</p>
  </div>

  <!-- Start Screen -->
  <div
    *ngIf="!isTestStarted && !isTestCompleted && !isLoading && !error"
    class="max-w-3xl mx-auto px-4 py-12"
  >
    <div class="bg-white rounded-lg shadow-lg p-8 text-center space-y-6">
      <h1 class="text-3xl font-bold text-gray-900 mb-4">
        {{ test?.name || "TOEIC Full Test" }}
      </h1>

      <div class="space-y-4 text-left bg-gray-50 p-6 rounded-lg">
        <div class="flex items-center gap-3">
          <fa-icon [icon]="faClock" class="text-blue-500 text-xl"></fa-icon>
          <span class="text-lg font-semibold">Thời gian: 2 giờ (120 phút)</span>
        </div>
        <div class="flex items-center gap-3">
          <fa-icon
            [icon]="faCheckCircle"
            class="text-blue-500 text-xl"
          ></fa-icon>
          <span class="text-lg font-semibold">Số câu hỏi: 200 câu</span>
        </div>
        <div class="flex items-center gap-3">
          <fa-icon
            [icon]="faCheckCircle"
            class="text-blue-500 text-xl"
          ></fa-icon>
          <span class="text-lg font-semibold"
            >Cấu trúc: Part 1 (6 câu), Part 2 (25 câu), Part 3 (39 câu), Part 4
            (30 câu), Part 5 (30 câu), Part 6 (70 câu)</span
          >
        </div>
      </div>

      <div class="bg-blue-50 p-6 rounded-lg text-left">
        <h3 class="font-semibold mb-3 text-lg">Hướng dẫn:</h3>
        <ul class="text-sm space-y-2 text-gray-700">
          <li>• Bạn có 2 giờ để hoàn thành 200 câu hỏi</li>
          <li>• Part 1-4 có audio, Part 1 có hình ảnh</li>
          <li>• Bạn có thể đánh dấu câu hỏi để xem lại sau</li>
          <li>• Bạn có thể điều hướng tự do giữa các câu hỏi</li>
          <li>• Nộp bài trước khi hết thời gian</li>
        </ul>
      </div>

      <div class="flex gap-4 justify-center">
        <button
          (click)="goBack()"
          class="px-6 py-3 bg-gray-200 hover:bg-gray-300 text-gray-800 rounded-lg font-semibold transition-colors"
        >
          <fa-icon [icon]="faArrowLeft" class="mr-2"></fa-icon>
          Quay lại
        </button>
        <button
          (click)="startTest()"
          class="px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-semibold transition-colors"
        >
          Bắt đầu làm bài
        </button>
      </div>
    </div>
  </div>

  <!-- Test Interface -->
  <div
    *ngIf="isTestStarted && !isTestCompleted && !isLoading && !error"
    class="flex h-[calc(100vh-80px)]"
  >
    <!-- Left Sidebar -->
    <div
      *ngIf="isQuestionGridVisible"
      class="w-64 bg-gray-100 border-r border-gray-300 overflow-y-auto"
    >
      <div class="p-4 space-y-4">
        <div *ngFor="let partInfo of PARTS" class="space-y-2">
          <h3 class="font-bold text-gray-700 text-sm uppercase">
            {{ partInfo.name }}
          </h3>
          <div class="grid grid-cols-5 gap-2">
            <button
              *ngFor="let num of getNumberRange(partInfo.start, partInfo.end)"
              (click)="goToQuestion(num - 1)"
              class="w-10 h-10 rounded-full border-2 flex items-center justify-center text-sm font-medium transition-all"
              [ngClass]="{
                'bg-blue-500 text-white border-blue-600':
                  currentQuestionIndex === num - 1,
                'bg-green-100 text-green-700 border-green-300':
                  getQuestionAnswer(num - 1),
                'bg-yellow-100 text-yellow-700 border-yellow-300':
                  markedQuestions.has(num - 1),
                'bg-white text-gray-700 border-gray-300 hover:bg-gray-50':
                  currentQuestionIndex !== num - 1 &&
                  !getQuestionAnswer(num - 1) &&
                  !markedQuestions.has(num - 1)
              }"
            >
              {{ num }}
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Main Content -->
    <div class="flex-1 flex flex-col overflow-hidden">
      <!-- Progress Indicator -->
      <div class="bg-orange-500 text-white px-4 py-2 text-right font-semibold">
        {{ getProgress() }}
      </div>

      <div class="flex-1 overflow-y-auto p-6">
        <div class="max-w-6xl mx-auto">
          <!-- Current Part -->
          <div class="mb-4">
            <span
              *ngIf="getCurrentPart()"
              class="text-blue-600 font-bold text-lg"
            >
              {{ getCurrentPart()?.name }}
            </span>
          </div>

          <div class="flex gap-6">
            <!-- Left Panel: Question and Image/Audio -->
            <div class="flex-1 space-y-6">
              <!-- Question Section -->
              <div class="bg-white rounded-lg border border-gray-200 p-6">
                <h3 class="text-lg font-semibold mb-4">Câu hỏi</h3>

                <!-- Image (for Part 1) -->
                <div *ngIf="getCurrentQuestion()?.imageUrl" class="mb-6">
                  <img
                    [src]="getCurrentQuestion()?.imageUrl"
                    [alt]="getCurrentQuestion()?.question || 'Question image'"
                    [title]="getCurrentQuestion()?.question || 'Question image'"
                    class="w-full max-w-md rounded-lg shadow-md"
                  />
                </div>

                <!-- Audio Player (for Part 1-4) -->
                <div *ngIf="getCurrentQuestion()?.audioUrl" class="mb-6">
                  <app-audio-player
                    [src]="getCurrentQuestion()?.audioUrl || ''"
                    [showTranscript]="false"
                  ></app-audio-player>
                </div>

                <!-- Question Text -->
                <div
                  *ngIf="getCurrentQuestion()?.question"
                  class="mb-6 text-lg"
                >
                  {{ getCurrentQuestion()?.question }}
                </div>
              </div>

              <!-- Answer Options -->
              <div class="bg-white rounded-lg border border-gray-200 p-6">
                <div class="text-xl font-bold mb-4">
                  {{ currentQuestionIndex + 1 }}.
                </div>
                <div class="space-y-3">
                  <button
                    *ngFor="
                      let option of getCurrentQuestion()?.options | keyvalue
                    "
                    (click)="selectAnswer(option.key)"
                    class="w-full p-4 text-left rounded-lg border-2 transition-all duration-200 flex items-center gap-3"
                    [ngClass]="{
                      'border-blue-500 bg-blue-50':
                        getSelectedAnswer() === option.key,
                      'border-gray-300 hover:bg-gray-50':
                        getSelectedAnswer() !== option.key
                    }"
                  >
                    <div
                      class="w-8 h-8 rounded-full border-2 flex items-center justify-center font-semibold"
                      [ngClass]="{
                        'border-blue-500 bg-blue-500 text-white':
                          getSelectedAnswer() === option.key,
                        'border-gray-400 text-gray-600':
                          getSelectedAnswer() !== option.key
                      }"
                    >
                      {{ option.key }}
                    </div>
                    <span class="flex-1">{{ option.value }}</span>
                  </button>
                </div>
              </div>

              <!-- Navigation Buttons -->
              <div class="flex justify-between items-center">
                <button
                  (click)="goToPreviousQuestion()"
                  [disabled]="currentQuestionIndex === 0"
                  class="px-6 py-2 bg-gray-200 hover:bg-gray-300 disabled:opacity-50 disabled:cursor-not-allowed rounded-lg font-semibold transition-colors"
                >
                  <fa-icon [icon]="faArrowLeft" class="mr-2"></fa-icon>
                  Câu trước
                </button>
                <button
                  (click)="toggleMarkQuestion()"
                  class="px-6 py-2 rounded-lg font-semibold transition-colors"
                  [ngClass]="{
                    'bg-yellow-500 hover:bg-yellow-600 text-white':
                      isQuestionMarked(),
                    'bg-gray-200 hover:bg-gray-300 text-gray-700':
                      !isQuestionMarked()
                  }"
                >
                  <fa-icon [icon]="faFlag" class="mr-2"></fa-icon>
                  {{ isQuestionMarked() ? "Bỏ đánh dấu" : "Đánh dấu" }}
                </button>
                <button
                  (click)="goToNextQuestion()"
                  [disabled]="currentQuestionIndex === questions.length - 1"
                  class="px-6 py-2 bg-blue-600 hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed text-white rounded-lg font-semibold transition-colors"
                >
                  Câu sau
                  <fa-icon
                    [icon]="faArrowRight"
                    class="ml-2 rotate-180"
                  ></fa-icon>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Completed Screen -->
  <div *ngIf="isTestCompleted" class="max-w-4xl mx-auto px-4 py-12">
    <div class="bg-white rounded-lg shadow-lg p-8 space-y-6">
      <!-- Header -->
      <div class="text-center">
        <h1 class="text-3xl font-bold text-gray-900 mb-2">
          Hoàn thành bài test
        </h1>
        <p class="text-lg text-gray-600">
          Bạn đã hoàn thành {{ getAnsweredCount() }}/{{ questions.length }} câu
          hỏi
        </p>
      </div>

      <!-- Score Display -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mt-8">
        <!-- Listening Score -->
        <div
          class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl p-6 text-white shadow-lg"
        >
          <div class="text-center">
            <div class="text-sm font-medium opacity-90 mb-2">ĐIỂM NGHE</div>
            <div class="text-4xl font-bold mb-2">{{ listeningScore }}</div>
            <div class="text-sm opacity-90">
              {{ listeningCorrect }}/{{ listeningTotal }} câu đúng
            </div>
          </div>
        </div>

        <!-- Total Score -->
        <div
          class="bg-gradient-to-br from-orange-500 to-orange-600 rounded-xl p-6 text-white shadow-lg"
        >
          <div class="text-center">
            <div class="text-sm font-medium opacity-90 mb-2">TỔNG ĐIỂM</div>
            <div class="text-5xl font-bold mb-2">{{ totalScore }}</div>
            <div class="text-xs opacity-90">/ 990 điểm</div>
          </div>
        </div>

        <!-- Reading Score -->
        <div
          class="bg-gradient-to-br from-green-500 to-green-600 rounded-xl p-6 text-white shadow-lg"
        >
          <div class="text-center">
            <div class="text-sm font-medium opacity-90 mb-2">ĐIỂM ĐỌC</div>
            <div class="text-4xl font-bold mb-2">{{ readingScore }}</div>
            <div class="text-sm opacity-90">
              {{ readingCorrect }}/{{ readingTotal }} câu đúng
            </div>
          </div>
        </div>
      </div>

      <!-- Detailed Statistics -->
      <div class="bg-gray-50 rounded-lg p-6 mt-6">
        <h3 class="text-lg font-semibold text-gray-800 mb-4">
          Thống kê chi tiết
        </h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div
            class="flex items-center justify-between p-3 bg-white rounded-lg"
          >
            <span class="text-gray-700 font-medium">Tổng số câu đúng:</span>
            <span class="text-lg font-bold text-blue-600">
              {{ listeningCorrect + readingCorrect }}/{{ questions.length }}
            </span>
          </div>
          <div
            class="flex items-center justify-between p-3 bg-white rounded-lg"
          >
            <span class="text-gray-700 font-medium">Tỷ lệ đúng:</span>
            <span class="text-lg font-bold text-green-600">
              {{ getCorrectPercentage() }}%
            </span>
          </div>
          <div
            class="flex items-center justify-between p-3 bg-white rounded-lg"
          >
            <span class="text-gray-700 font-medium">Nghe đúng:</span>
            <span class="text-lg font-bold text-blue-600">
              {{ listeningCorrect }}/{{ listeningTotal }}
            </span>
          </div>
          <div
            class="flex items-center justify-between p-3 bg-white rounded-lg"
          >
            <span class="text-gray-700 font-medium">Đọc đúng:</span>
            <span class="text-lg font-bold text-green-600">
              {{ readingCorrect }}/{{ readingTotal }}
            </span>
          </div>
        </div>
      </div>

      <!-- Action Buttons -->
      <div class="flex gap-4 justify-center mt-6">
        <button
          (click)="goBack()"
          class="px-6 py-3 bg-gray-200 hover:bg-gray-300 text-gray-800 rounded-lg font-semibold transition-colors"
        >
          <fa-icon [icon]="faArrowLeft" class="mr-2"></fa-icon>
          Quay lại danh sách
        </button>
      </div>
    </div>
  </div>
</div>
