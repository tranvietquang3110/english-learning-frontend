<div class="change-password-container">
  <div class="card">
    <h2 class="card-title">Đổi mật khẩu</h2>

    <!-- Success Message -->
    <div *ngIf="successMessage" class="alert alert-success">
      {{ successMessage }}
    </div>

    <!-- Error Message -->
    <div *ngIf="errorMessage" class="alert alert-error">
      {{ errorMessage }}
    </div>

    <!-- Step 1: OTP Verification -->
    <div *ngIf="currentStep === 'otp'" class="otp-step">
      <p class="info-text">
        Mã OTP đã được gửi đến email: <strong>{{ email }}</strong>
      </p>

      <form [formGroup]="otpForm" (ngSubmit)="verifyOtp()">
        <div class="otp-input-group">
          <label class="form-label">Nhập mã OTP (4 số)</label>
          <div class="otp-inputs" id="inputs">
            <input
              inputmode="numeric"
              maxlength="1"
              class="otp-input"
              #inputField
              type="text"
              (keyup)="onKeyUp($event)"
              *ngFor="let field of otpFields; let i = index"
              [attr.aria-label]="'OTP digit ' + (i + 1)"
              placeholder="0"
              autocomplete="off"
              [class.error]="
                otpForm.get('otp')?.invalid && otpForm.get('otp')?.touched
              "
            />
          </div>
          <div
            *ngIf="otpForm.get('otp')?.invalid && otpForm.get('otp')?.touched"
            class="error-message"
          >
            Vui lòng nhập đầy đủ 4 số OTP
          </div>
        </div>

        <div class="form-actions">
          <button type="submit" class="btn btn-primary" [disabled]="isLoading">
            <span *ngIf="isLoading">Đang xử lý...</span>
            <span *ngIf="!isLoading">Xác thực OTP</span>
          </button>
        </div>
      </form>
      <hr class="divider" />
      <div class="resend-section">
        <div
          *ngIf="canResendOtp"
          class="resend-link"
          (click)="resendOtp()"
          [class.disabled]="isLoading"
        >
          Gửi lại mã OTP
        </div>
        <p *ngIf="!canResendOtp" class="resend-timer">
          Vui lòng chờ {{ remainingTime }} giây nữa để gửi lại mã OTP.
        </p>
      </div>
    </div>

    <!-- Step 2: New Password -->
    <div *ngIf="currentStep === 'password'" class="password-step">
      <form [formGroup]="passwordForm" (ngSubmit)="resetPassword()">
        <div class="form-group">
          <label class="form-label" for="newPassword">Mật khẩu mới</label>
          <input
            id="newPassword"
            type="password"
            class="form-input"
            formControlName="newPassword"
            placeholder="Nhập mật khẩu mới (tối thiểu 6 ký tự)"
            [class.error]="
              passwordForm.get('newPassword')?.invalid &&
              passwordForm.get('newPassword')?.touched
            "
          />
          <div
            *ngIf="
              passwordForm.get('newPassword')?.invalid &&
              passwordForm.get('newPassword')?.touched
            "
            class="error-message"
          >
            <span *ngIf="passwordForm.get('newPassword')?.errors?.['required']">
              Mật khẩu mới là bắt buộc
            </span>
            <span
              *ngIf="passwordForm.get('newPassword')?.errors?.['minlength']"
            >
              Mật khẩu phải có ít nhất 6 ký tự
            </span>
          </div>
        </div>

        <div class="form-group">
          <label class="form-label" for="confirmPassword"
            >Xác nhận mật khẩu mới</label
          >
          <input
            id="confirmPassword"
            type="password"
            class="form-input"
            formControlName="confirmPassword"
            placeholder="Nhập lại mật khẩu mới"
            [class.error]="(passwordForm.get('confirmPassword')?.invalid || passwordForm.errors?.['passwordMismatch']) && passwordForm.get('confirmPassword')?.touched"
          />
          <div
            *ngIf="(passwordForm.get('confirmPassword')?.invalid || passwordForm.errors?.['passwordMismatch']) && passwordForm.get('confirmPassword')?.touched"
            class="error-message"
          >
            <span
              *ngIf="passwordForm.get('confirmPassword')?.errors?.['required']"
            >
              Xác nhận mật khẩu là bắt buộc
            </span>
            <span *ngIf="passwordForm.errors?.['passwordMismatch']">
              Mật khẩu xác nhận không khớp
            </span>
          </div>
        </div>

        <div class="form-actions">
          <button
            type="submit"
            class="btn btn-primary"
            [disabled]="isLoading || passwordForm.invalid"
          >
            <span *ngIf="isLoading">Đang xử lý...</span>
            <span *ngIf="!isLoading">Đổi mật khẩu</span>
          </button>
          <button
            type="button"
            class="btn btn-secondary"
            (click)="resetForms()"
            [disabled]="isLoading"
          >
            Quay lại
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
